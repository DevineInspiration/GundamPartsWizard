<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gundam Parts Wizard - Clean Export</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #aaa; padding: 8px; }
    input, select { width: 100%; box-sizing: border-box; }
    input[readonly] { background-color: #eee; color: #555; border: 1px solid #ccc; }
    button { margin-top: 10px; }
    .parts-view td { background: #fafafa; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body>
  <h1>Gundam Parts Wizard (Clean Export)</h1>

  <input type="file" id="csvFileInput" accept=".csv" onchange="importCSV(event)" />
  
  <div style="margin-top: 10px;">
	  <label><strong>Kit Name:</strong></label>
	  <input type="text" id="globalKitName" placeholder="e.g. RX-78-2 Gundam" style="width: 300px; margin-right: 20px;" />
	  <label><strong>Part Price:</strong></label>
	  <input type="number" id="globalPartPrice" placeholder="e.g. 3.50" style="width: 100px;" step="0.01" />
	</div>
  
  <button onclick="addRow()">Add Row</button>
  <button onclick="downloadCSV()">Download CSV</button>

  <table id="inputTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>Runner Name</th>
        <th>Handle</th>
        <th>Title</th>
        <th>Parts</th>
        <th>Parts View</th>
        <th>Barcode</th>
        <th>Remove</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <script>
    const tableBody = document.getElementById('tableBody');
    const HIDDEN_COLUMNS = [
      "Variant Grams", "Variant Inventory Tracker", "Variant Inventory Qty",
      "Variant Inventory Policy", "Variant Fulfillment Service",
      "Variant Requires Shipping", "Variant Taxable" 

    ];
    let CSV_HEADER_MAP = {};

    function toHandle(str) {
      return str.toLowerCase().trim().replace(/[^\w\s-]/g, '').replace(/\s+/g, '-');
    }

    function addRow(runnerName = '', handle = '', title = '', partsCount = 1, barcode = '', id = '') {
      const count = tableBody.querySelectorAll('tr').length + 1;
      const rowId = id || `id-${count}`;
      const handleVal = handle || `runner-${count}`;
      const titleVal = title || `Runner ${runnerName}`;
      const barcodeVal = barcode || '';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input name="id" value="${rowId}" readonly /></td>
        <td><input name="runnerName" value="${runnerName}" /></td>
        <td><input name="Handle" value="${handleVal}" /></td>
        <td><input name="title" value="${titleVal}" /></td>
        <td><input name="parts" type="number" value="${partsCount}" min="1" /></td>
        <td><button onclick="toggleParts(this)">Show</button></td>
        <td><input name="barcode" value="${barcodeVal}" /></td>
        <td><button onclick="removeRow(this)">Remove</button></td>
      `;
      tableBody.appendChild(tr);
    }

    function removeRow(btn) {
      const row = btn.closest('tr');
      const next = row.nextElementSibling;
      if (next && next.classList.contains('parts-view')) next.remove();
      row.remove();
    }

    function toggleParts(btn) {
      const row = btn.closest('tr');
      const next = row.nextElementSibling;
      if (next && next.classList.contains('parts-view')) {
        next.remove();
        btn.textContent = 'Show';
        return;
      }

      const runnerName = row.querySelector('[name="runnerName"]').value;
      const handle = row.querySelector('[name="Handle"]').value;
      const title = row.querySelector('[name="title"]').value;
      const partsCount = parseInt(row.querySelector('[name="parts"]').value) || 1;
      const barcode = row.querySelector('[name="barcode"]').value;

      const viewRow = document.createElement('tr');
      viewRow.className = 'parts-view';
      let html = `<td colspan="8"><table border="1" width="100%"><tr>
        <th>#</th><th>Variant Name</th><th>Variant SKU</th><th>Runner</th><th>Title</th></tr>`;

      for (let i = 1; i <= partsCount; i++) {
        const variantName = `${runnerName}-${i}`;
        const variantSKU = `${barcode} ${variantName}`;
        html += `<tr>
          <td>${i}</td>
          <td>${variantName}</td>
          <td>${variantSKU}</td>
          <td>${runnerName}</td>
          <td>${title}</td>
        </tr>`;
      }

      html += `</table></td>`;
      viewRow.innerHTML = html;
      row.after(viewRow);
      btn.textContent = 'Hide';
    }

    function importCSV(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => parseCSV(e.target.result);
      reader.readAsText(file);
    }

	function parseCSV(text) {
	  tableBody.innerHTML = '';

	  const result = Papa.parse(text, {
		header: true,
		skipEmptyLines: true,
	  });

	  const data = result.data;
	  const groups = {};

	  data.forEach((row, i) => {
		const handle = row['Handle'] || `handle-${i}`;
		if (!groups[handle]) groups[handle] = [];
		groups[handle].push(row);
	  });

	  let count = 0;
	  for (const handle in groups) {
		const rows = groups[handle];
		const main = rows[0];
		const title = main['Title'] || handle;
		const barcode = main['Variant SKU'] || '';
		const runnerName = main['Runner Name'] || handle.split('-').slice(-1)[0];
		const partsCount = rows.length;

		addRow(runnerName, handle, title, partsCount, barcode, `id-${++count}`);
		const lastRow = tableBody.lastElementChild;
		lastRow.dataset.parts = JSON.stringify(rows.slice(1));
		lastRow.dataset.handle = handle;
		lastRow.dataset.title = title;
		lastRow.dataset.barcode = barcode;

		// Collect hidden column data
		lastRow.dataset.hidden = JSON.stringify(
		  rows.map(r => {
			const extra = {};
			for (const col of HIDDEN_COLUMNS) {
			  extra[col] = r[col] || '';
			}
			return extra;
		  })
		);
	  }
	}

	function downloadCSV() {
      const kitName = document.getElementById('globalKitName')?.value.trim() || '';
      const partPrice = document.getElementById('globalPartPrice')?.value.trim() || '';

      const rows = [['Handle','Title','Body(HTML)','Vendor','Product Category','Type','Tags','Published','Option1 Name','Option1 Value','Option1 Linked To','Option2 Name','Option2 Value','Option2 Linked To','Option3 Name','Option3 Value','Option3 Linked To','Variant SKU','Barcode','Kit Name','Part Price', ...HIDDEN_COLUMNS]];

      for (const row of tableBody.querySelectorAll('tr')) {
        if (row.classList.contains('parts-view')) continue;

        const handleInput = row.querySelector('[name="Handle"]');
        const titleInput = row.querySelector('[name="title"]');
        const partsInput = row.querySelector('[name="parts"]');
        const barcodeInput = row.querySelector('[name="barcode"]');
        const runnerInput = row.querySelector('[name="runnerName"]');

        if (!handleInput || !titleInput || !partsInput || !barcodeInput || !runnerInput) continue;

        const handle = handleInput.value.trim();
        const title = titleInput.value.trim();
        const partsCount = parseInt(partsInput.value.trim()) || 1;
        const barcode = barcodeInput.value.trim();
        const runner = runnerInput.value.trim();

        const hiddenParts = JSON.parse(row.dataset.hidden || '[]');

        for (let i = 1; i <= partsCount; i++) {
          const vName = `${runner}-${i}`;
          const vSKU = `${barcode} ${vName}`;
          const hidden = hiddenParts[i - 1] || {};
          rows.push([
            handle, title, '', '', '', '', '', '',
            'Part Number', vName, '', '', '', '', '', '', '',
            vSKU, barcode, kitName, partPrice,
            ...HIDDEN_COLUMNS.map(k => (hidden[k]?.trim?.() || "").trim())
          ]);
        }
      }

	  const content = rows.map(r => r.map(f => `"${String(f).replace(/"/g, '""')}"`).join(',')).join('\\r\n');
	  
      const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'gundam_parts_clean_export.csv';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }


    addRow();
  </script>
</body>
</html>
